FROM --platform=$BUILDPLATFORM maven:3-jdk-8 as downloader


SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN apt-get update && apt-get install -y --no-install-recommends git zip unzip

WORKDIR /tmp/geonetwork
COPY . /tmp/geonetwork/
# Protect kibnana dashboards
RUN sed -i "s/<sec:filter-chain\s* pattern=\"\/dashboards\/\*\*\"\s* filters=\"\"/<sec:filter-chain pattern=\"\/dashboards\/**\" filters=\"securityContextPersistenceFilter, adminUserFilter\"/" "web/src/main/webapp/WEB-INF/config-security/config-security-core.xml"
#RUN    cat "web/src/main/webapp/WEB-INF/config-security/config-security-core.xml" | grep dashboards


RUN --mount=type=cache,target=/root/.m2/repository \
     mvn -X -B -f pom.xml clean install -DskipTests -T2C
RUN find web/target -name git.properties
RUN mkdir -p /var/lib/jetty/webapps
RUN unzip web/target/geonetwork.war  -d /var/lib/jetty/webapps/geonetwork

 


#####################################################################
FROM tomcat:8.5-jdk8

ARG DATA_DIR

RUN test -n "$DATA_DIR"

ENV CATALINA_OPTS "-Dgeonetwork.dir=$DATA_DIR -Dgeonetwork.schema.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins -Dgeonetwork.formatter.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/data/formatter"
ENV JAVA_OPTS "-Xmx2048M -Xss2M -XX:+UseConcMarkSweepGC -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true"

SHELL ["/bin/bash", "-o", "pipefail", "-c"]


COPY --from=downloader /var/lib/jetty/webapps/geonetwork ${CATALINA_HOME}/webapps/geonetwork

RUN cp "${CATALINA_HOME}"/webapps/geonetwork/WEB-INF/lib/postgresql-*.jar "${CATALINA_HOME}/lib" \
    && mkdir -p ${DATA_DIR}


COPY ./docker/geocat/entrypoint.sh  /entrypoint.sh
ENTRYPOINT [ "/entrypoint.sh" ]
CMD ["catalina.sh", "run"]
EXPOSE 8080 8009
