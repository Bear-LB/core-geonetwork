FROM --platform=$BUILDPLATFORM ubuntu:focal as downloader


SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN mkdir -p /var/lib/jetty/webapps

RUN apt-get update && apt-get install -y --no-install-recommends unzip

WORKDIR /tmp/geonetwork
COPY war/geonetwork.war .
RUN unzip geonetwork.war -d geonetwork
# Protect kibnana dashboards
RUN sed -i "s/<sec:filter-chain\s* pattern=\"\/dashboards\/\*\*\"\s* filters=\"\"/<sec:filter-chain pattern=\"\/dashboards\/**\" filters=\"securityContextPersistenceFilter, adminUserFilter\"/" "geonetwork/WEB-INF/config-security/config-security-core.xml"
#RUN    cat "web/src/main/webapp/WEB-INF/config-security/config-security-core.xml" | grep dashboards


 


#####################################################################
FROM tomcat:8.5-jdk8

ARG DATA_DIR

RUN test -n "$DATA_DIR"

ENV CATALINA_OPTS "-Dgeonetwork.dir=$DATA_DIR -Dgeonetwork.schema.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins -Dgeonetwork.formatter.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/data/formatter"
ENV JAVA_OPTS "-Xmx2048M -Xss2M -XX:+UseConcMarkSweepGC -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true"

SHELL ["/bin/bash", "-o", "pipefail", "-c"]


COPY --from=downloader /tmp/geonetwork/geonetwork ${CATALINA_HOME}/webapps/geonetwork

RUN cp "${CATALINA_HOME}"/webapps/geonetwork/WEB-INF/lib/postgresql-*.jar "${CATALINA_HOME}/lib" \
    && mkdir -p ${DATA_DIR}


COPY ./entrypoint.sh  /entrypoint.sh
ENTRYPOINT [ "/entrypoint.sh" ]
CMD ["catalina.sh", "run"]
EXPOSE 8080 8009
